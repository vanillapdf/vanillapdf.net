name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  packages: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.parse.outputs.tag }}
      build_suffix: ${{ steps.parse.outputs.build_suffix }}
      prerelease: ${{ steps.parse.outputs.prerelease }}
    steps:
      - name: Extract tag name and suffix
        id: parse
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          VERSION="${TAG#v}"
          EXTRA=""
          if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(.*)$ ]]; then
            EXTRA="${BASH_REMATCH[1]}"
          fi
          if [[ -n "$EXTRA" ]]; then
            EXTRA="${EXTRA#-}"
            echo "build_suffix=$EXTRA" >> "$GITHUB_OUTPUT"
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "build_suffix=" >> "$GITHUB_OUTPUT"
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
          fi

  verify:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v6

      - name: Verify VersionPrefix matches tag
        run: |
          TAG="${{ needs.prepare.outputs.tag }}"
          VERSION="${TAG#v}"

          # Strip any pre-release suffix (e.g., 2.2.0-rc1 -> 2.2.0)
          BASE_VERSION=$(echo "$VERSION" | cut -d- -f1)

          # Read VersionPrefix from csproj
          CSPROJ_VERSION=$(grep -oP '<VersionPrefix>\K[^<]+' src/vanillapdf.net/vanillapdf.net.csproj)

          echo "Tag version: $BASE_VERSION"
          echo "csproj VersionPrefix: $CSPROJ_VERSION"

          if [ "$BASE_VERSION" != "$CSPROJ_VERSION" ]; then
            echo "::error::Version mismatch: tag=$BASE_VERSION, csproj=$CSPROJ_VERSION"
            exit 1
          fi

          echo "Version verified: $BASE_VERSION"

  build-nuget:
    needs: [verify, prepare]
    uses: ./.github/workflows/build-nuget.yml
    with:
      build_suffix: ${{ needs.prepare.outputs.build_suffix }}

  nuget-staging:
    runs-on: ubuntu-latest
    environment: staging
    needs: build-nuget
    steps:
      - name: Download NuGet packages
        uses: actions/download-artifact@v7
        with:
          path: ./nupkgs

      - name: Push to GitHub Packages
        run: |
          dotnet nuget push nupkgs/**/*.nupkg \
            --source "${{ vars.NUGET_SOURCE }}" \
            --api-key "${{ secrets.GITHUB_TOKEN }}" \
            --skip-duplicate

  production-gate:
    runs-on: ubuntu-latest
    needs: nuget-staging
    environment: production
    steps:
      - run: echo "Awaiting production approval"

  publish-nuget:
    runs-on: ubuntu-latest
    needs: production-gate
    environment: production
    steps:
      - name: Download NuGet packages
        uses: actions/download-artifact@v7
        with:
          path: ./nupkgs

      - name: Push to NuGet.org
        run: |
          dotnet nuget push nupkgs/**/*.nupkg \
            --source "${{ vars.NUGET_SOURCE }}" \
            --api-key "${{ secrets.NUGET_API_KEY }}" \
            --skip-duplicate

  github-release:
    needs: [production-gate, prepare]
    uses: ./.github/workflows/github-release.yml
    with:
      tag: ${{ needs.prepare.outputs.tag }}
      # Convert string output to boolean (job outputs are always strings)
      prerelease: ${{ needs.prepare.outputs.prerelease == 'true' }}
    secrets: inherit
